<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="/blog2-ssr/images/favicon-compressed.webp">
    <link rel="shortcut icon" href="/blog2-ssr/images/favicon-compressed.webp">
    <link rel="apple-touch-icon" href="/blog2-ssr/images/favicon-compressed.webp">

    <link rel="stylesheet" href="/blog2-ssr/shared.css">
    <link rel="stylesheet" href="/blog2-ssr/prism.css">

    <title>Erlang example 2.0</title></head>
<body class="svelte-1gr3n62"><style>:root{--left-side:200px;--right-side:200px;--nav-height:64px;--background-color:#FFD166;--primary-color:#06D6A0;--primary-accent-color:#049F76;--secondary-color:#118AB2;--sub-color:#073B4C;--nav-background:#fff;--article-background:#fff
    }body.svelte-1gr3n62.svelte-1gr3n62{padding:0;margin:0;color:var(--sub-color);background:var(--background-color);font-family:Roboto, "Helvetica Neue", Arial, sans-serif;font-size:18px;display:grid;grid-template:var(--nav-height) auto var(--nav-height)/var(--left-side) calc(100% - var(--left-side) - var(--right-side)) var(--right-side)
    }nav.top.svelte-1gr3n62 .links.svelte-1gr3n62{grid-area:1/2/2/3;display:flex;align-items:center
    }nav.top.svelte-1gr3n62 .links a.svelte-1gr3n62{margin-right:1em
    }a.svelte-1gr3n62.svelte-1gr3n62{color:var(--secondary-color);text-decoration:none
    }a.svelte-1gr3n62.svelte-1gr3n62:hover,a.svelte-1gr3n62.svelte-1gr3n62:active{color:var(--sub-color)
    }footer.svelte-1gr3n62.svelte-1gr3n62{grid-area:3/1/4/4;background:#fff;display:inline-grid;grid-template:100%/var(--left-side) auto var(--right-side)
    }nav.top.svelte-1gr3n62.svelte-1gr3n62{background-color:var(--nav-background);display:inline-grid;grid-template:100%/var(--left-side) auto var(--right-side);grid-area:1/1/2/4
    }main.svelte-1gr3n62.svelte-1gr3n62{grid-area:2/2/3/3;margin-top:1em;display:flex;flex-direction:column
    }@media screen and (max-width: 1340px){:root{--left-side:0px;--right-side:0px
        }body.svelte-1gr3n62.svelte-1gr3n62{background:var(--background-color)
        }nav.top.svelte-1gr3n62 .links.svelte-1gr3n62{justify-content:space-around
        }}
.btn.svelte-7idbpu{display:inline-flex;font-size:18px;color:#fff;background:var(--primary-color);padding:10px;border-radius:8px
    }.btn.svelte-7idbpu:hover{background:var(--primary-accent-color);color:#fff
    }</style>

    <nav class="top svelte-1gr3n62">
            <div class="links svelte-1gr3n62"><a class="nav-link nav-item svelte-1gr3n62" href="/blog2-ssr/">Home</a>
                <a class="nav-link nav-item svelte-1gr3n62" href="/blog2-ssr/about/">About</a></div>
        </nav>

    <main class="svelte-1gr3n62"><article><h1>Erlang example 2.0</h1>

    <time>07 Nov 2020 at 02:42</time>

    <div class="content"><p>Quite some time ago I’ve published a <a href="tumblr/2015-01-28-erlang-practice">blogpost about Erlang</a>. It claimed to present a <em>short intro to distributed programming in Erlang</em>. But it turned to be a very simple communication application, nothing super-exciting.</p>
<p>In this post I would like to elaborate more on the topic of Erlang, for a number of reasons:</p>
<ul>
<li>it is a pretty simple language itself</li>
<li>the distributed systems topic gets more and more of my attention these days</li>
<li>when I was looking at Erlang, I would love to see a more advanced tutorial myself <em>(more practical things and more Erlang platform features showcased)</em></li>
</ul>
<!--more-->

<h2 id="language-features">Language features</h2>
<p>Kicking off with the language features, let’s discover few data structures available out of the box.</p>
<p>I was thinking for few a while about what could be showcased in Erlang. I think the system we’ll develop closer to the end of this blog
is quite nice.</p>
<h3 id="tuples">Tuples</h3>
<p>As you might remember from the <a href="2020-01-10-erlang-in-5-minutes">quick introduction to Erlang</a>, tuples are defined like this:</p>
<pre><code class="language-erlang"><span class="token variable">X</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token atom">elt1</span><span class="token punctuation">,</span> <span class="token atom">elt2</span><span class="token punctuation">,</span> <span class="token atom">elt3</span><span class="token punctuation">,</span> <span class="token atom">elt5</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>Now, since there are no datatypes or alike in Erlang, we can use tuples to denote complex data structures, like trees, for example:</p>
<pre><code class="language-erlang"><span class="token variable">Tree</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>With this, let us create a module to work with binary trees:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">binary_tree</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token atom">create_tree</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token atom">insert_into_tree</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">N</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">N</span><span class="token punctuation">,</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token atom">nil</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">nil</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">NewNode</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">NewNode</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>The idea behind <code>insert_into_tree/2</code> is that every call has to return the copy of a current tree with a recursively modified leaf.</p>
<p>Now, to test the binary tree, we can define a function that checks if a node is in tree or not:</p>
<pre><code class="language-erlang"><span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Parent</span> <span class="token operator">=:=</span> <span class="token variable">Value</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>You might want to compile the module now, by running</p>
<pre><code class="language-bash"><span class="token variable">$erlc</span> binary_tree.erl
</code></pre>
<p>We can run the program to construct a tree and check if some element is in there:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token atom">binary_tree</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Tree</span> <span class="token operator">=</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token variable">X1</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token variable">X2</span> <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">,</span>
  <span class="token variable">X1Present</span> <span class="token operator">=</span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token variable">X2Present</span> <span class="token operator">=</span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">io</span><span class="token punctuation">:</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"Tree: ~p~n"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">Tree</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">io</span><span class="token punctuation">:</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"~p in tree (~p)~n"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">X1</span><span class="token punctuation">,</span> <span class="token variable">X1Present</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">io</span><span class="token punctuation">:</span><span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"~p in tree (~p)~n"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">X2</span><span class="token punctuation">,</span> <span class="token variable">X2Present</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>This is a bit cumbersome, so let’s use the <code>lists:foldl/3</code> function together with a list of values to construct the tree in a more convenient way:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token atom">lists</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">foldl</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Values</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token variable">Tree</span> <span class="token operator">=</span> <span class="token atom">lists</span><span class="token punctuation">:</span><span class="token function">foldl</span><span class="token punctuation">(</span><span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token variable">Elt</span><span class="token punctuation">,</span> <span class="token variable">Acc</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Acc</span><span class="token punctuation">,</span> <span class="token variable">Elt</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">,</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">Values</span><span class="token punctuation">)</span>
  <span class="token comment">% ...</span>
  <span class="token punctuation">.</span>
</code></pre>
<h3 id="records">Records</h3>
<p>There is a mechanism in Erlang called <em>records</em>. It is basically a syntactic sugar around tuples, just as we have used them above, but it gives a little bit more clarity for pattern matching when writing code:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">value</span><span class="token punctuation">,</span> <span class="token atom">left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">N</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">N</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token atom">nil</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token atom">nil</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">NewNode</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">NewNode</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">_</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">_</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">_</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">_</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Parent</span> <span class="token operator">=:=</span> <span class="token variable">Value</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">_</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">Right</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">Parent</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">_</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Parent</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>Well, it does make pattern matching more explicit, but the code has just blown up!
Luckily, Erlang does provide a syntactic sugar to read a specific field of a record and to update specific record’ fields:</p>
<pre><code class="language-erlang"><span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">right</span> <span class="token operator">=:=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token comment">% read specific fields from Tree, namely - right and value</span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">NewNode</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">% update only the tree.right value, leave the rest values of Tree unchanged</span>
</code></pre>
<p>This makes a module a bit shorter again:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">tree</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">value</span><span class="token punctuation">,</span> <span class="token atom">left</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">N</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">value</span> <span class="token operator">=</span> <span class="token variable">N</span><span class="token punctuation">,</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token atom">nil</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">right</span> <span class="token operator">=:=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token variable">NewNode</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">left</span> <span class="token operator">=:=</span> <span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">NewNode</span> <span class="token operator">=</span> <span class="token function">create_tree</span><span class="token punctuation">(</span><span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token variable">NewNode</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">right</span> <span class="token operator">=</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">{</span> <span class="token atom">left</span> <span class="token operator">=</span> <span class="token function">insert_into_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token atom">nil</span><span class="token punctuation">,</span> <span class="token variable">_</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">=:=</span> <span class="token variable">Value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">>=</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">right</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span>
  <span class="token keyword">when</span> <span class="token variable">Value</span> <span class="token operator">&lt;</span> <span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">value</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token function">is_in_tree</span><span class="token punctuation">(</span><span class="token variable">Tree</span><span class="token punctuation">#</span><span class="token atom">tree</span><span class="token punctuation">.</span><span class="token atom">left</span><span class="token punctuation">,</span> <span class="token variable">Value</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<h3 id="maps">Maps</h3>
<p>Well, having records is good and nice. But what if we want a hashmap?
Consider a trie data structure, where it has a value and a map of characters to nodes.
Technically, we could have a list of nodes and iterate over them whenever we need to access a specific child.
But that would be a waste of time.</p>
<p>Luckily, Erlang does provide the <code>maps</code> module:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">trie</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token atom">lists</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">foldl</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">-</span><span class="token function">import</span><span class="token punctuation">(</span><span class="token atom">maps</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">is_key</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token atom">get</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token atom">put</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token atom">new</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token atom">insert</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token atom">contains</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">trie</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">stop</span><span class="token punctuation">,</span> <span class="token atom">children</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">#</span><span class="token atom">trie</span><span class="token punctuation">{</span> <span class="token atom">stop</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token atom">children</span> <span class="token operator">=</span> <span class="token punctuation">#</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">Trie</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span> <span class="token punctuation">{</span> <span class="token atom">stop</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">Trie</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">Char</span><span class="token punctuation">|</span><span class="token variable">Chars</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Children</span> <span class="token operator">=</span> <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span><span class="token punctuation">.</span><span class="token atom">children</span><span class="token punctuation">,</span>
  <span class="token variable">IsChild</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">is_key</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">if</span>
    <span class="token variable">IsChild</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">-</span><span class="token operator">></span>
      <span class="token variable">SubTrie</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">NewSubTrie</span> <span class="token operator">=</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">SubTrie</span><span class="token punctuation">,</span> <span class="token variable">Chars</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">NewChildren</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">NewSubTrie</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span> <span class="token punctuation">{</span> <span class="token atom">children</span> <span class="token operator">=</span> <span class="token variable">NewChildren</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token boolean">true</span> <span class="token operator">-</span><span class="token operator">></span>
      <span class="token variable">SubTrie</span> <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">NewSubTrie</span> <span class="token operator">=</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token variable">SubTrie</span><span class="token punctuation">,</span> <span class="token variable">Chars</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">NewChildren</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">NewSubTrie</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span> <span class="token punctuation">{</span> <span class="token atom">children</span> <span class="token operator">=</span> <span class="token variable">NewChildren</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span><span class="token punctuation">.</span>

<span class="token function">contains</span><span class="token punctuation">(</span><span class="token variable">Trie</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span><span class="token punctuation">.</span><span class="token atom">stop</span><span class="token punctuation">;</span>

<span class="token function">contains</span><span class="token punctuation">(</span><span class="token variable">Trie</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token variable">Char</span><span class="token punctuation">|</span><span class="token variable">Chars</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Children</span> <span class="token operator">=</span> <span class="token variable">Trie</span><span class="token punctuation">#</span><span class="token atom">trie</span><span class="token punctuation">.</span><span class="token atom">children</span><span class="token punctuation">,</span>
  <span class="token variable">IsChild</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">is_key</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">if</span>
    <span class="token variable">IsChild</span> <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">-</span><span class="token operator">></span>
      <span class="token variable">SubTrie</span> <span class="token operator">=</span> <span class="token atom">maps</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">Char</span><span class="token punctuation">,</span> <span class="token variable">Children</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">contains</span><span class="token punctuation">(</span><span class="token variable">SubTrie</span><span class="token punctuation">,</span> <span class="token variable">Chars</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token boolean">true</span> <span class="token operator">-</span><span class="token operator">></span>
      <span class="token boolean">false</span>
  <span class="token keyword">end</span><span class="token punctuation">.</span>
</code></pre>
<p>Quite unfortunately, pretty much none of the handy maps syntax is implemented yet.</p>
<h2 id="platform-features">Platform features</h2>
<p>Let’s start with few simple but practical examples.</p>
<h3 id="web-server">Web-server</h3>
<p>Erlang comes packed with a lot of features. One of them is bundled web-server. Some time ago I’ve published a post about a very simple Tetris game, which I’ve crafted one evening. The thing is: that game is nothing more than a single HTML page. What we can do now is start a web server, which will listen for connections on <code>8080</code> port and serve them a static file with the game.</p>
<p>The code is pretty simple:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">simple_web_server</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token atom">run_server</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token atom">stop_server</span><span class="token operator">/</span><span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">run_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">inets</span><span class="token punctuation">:</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">inets</span><span class="token punctuation">:</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token atom">httpd</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token atom">port</span><span class="token punctuation">,</span> <span class="token number">8080</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">server_name</span><span class="token punctuation">,</span> <span class="token string">"httpd_test"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">server_root</span><span class="token punctuation">,</span> <span class="token string">"."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">document_root</span><span class="token punctuation">,</span> <span class="token string">"."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">bind_address</span><span class="token punctuation">,</span> <span class="token atom">any</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">stop_server</span><span class="token punctuation">(</span><span class="token variable">Pid</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">inets</span><span class="token punctuation">:</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token atom">httpd</span><span class="token punctuation">,</span> <span class="token variable">Pid</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>But modern web applications require a server that will have some sort of an API. Take REST for example - when a URL of a specific format with specific HTTP method (<code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>DELETE</code>, etc.) is hit on the server, some behaviour is expected. For instance, <code>curl -X GET http://server.address/posts</code> request is expected to return a list of all <code>Post</code> entities (whatever that means in the context of an application), whereas <code>curl -X PUT http://server.address/posts -d &#39;{ &quot;title&quot;: &quot;post #1&quot;, &quot;content&quot;: &quot;blah&quot; }&#39; -H &quot;Content-Type: application/json&quot;</code> is expected to create a <code>Post</code> entity with fields <code>title</code> and <code>content</code> from the request.</p>
<p>The bundled Erlang HTTP server, <code>httpd</code> kind of allows for that, except the URLs will be in a format <code>cgi-bin/erl/mymodule:mymethod</code>, which is not exactly what we want.
But just for the sake of example, here’s how it would look like implemented with httpd:</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">posts</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token atom">get</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token atom">all</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token atom">create</span><span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">get</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token variable">Env</span><span class="token punctuation">,</span> <span class="token variable">Input</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token string">"Content-Type:application/json\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token function">do_get</span><span class="token punctuation">(</span><span class="token variable">Input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">do_get</span><span class="token punctuation">(</span><span class="token variable">Input</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">QueryParams</span> <span class="token operator">=</span> <span class="token atom">uri_string</span><span class="token punctuation">:</span><span class="token function">dissect_query</span><span class="token punctuation">(</span><span class="token variable">Input</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token punctuation">{</span> <span class="token variable">_IdParamName</span><span class="token punctuation">,</span> <span class="token variable">Id</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom">lists</span><span class="token punctuation">:</span><span class="token function">search</span><span class="token punctuation">(</span><span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token variable">Key</span><span class="token punctuation">,</span> <span class="token variable">_Value</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token variable">Key</span> <span class="token operator">==</span> <span class="token string">"id"</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token punctuation">[</span><span class="token string">"{\"id\":1,\"title\": \"post 1\", \"content\": \"blah\"}"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

<span class="token function">all</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token variable">Env</span><span class="token punctuation">,</span> <span class="token variable">Input</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token string">"Content-Type:application/json\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token function">do_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">do_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token punctuation">[</span><span class="token string">"[{\"title\": \"post 1\", \"content\": \"blah\"}]"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>

<span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token variable">Env</span><span class="token punctuation">,</span> <span class="token variable">Input</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token string">"Content-Type:application/json\r\n\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mod_esi</span><span class="token punctuation">:</span><span class="token function">deliver</span><span class="token punctuation">(</span><span class="token variable">SessionID</span><span class="token punctuation">,</span> <span class="token function">do_create</span><span class="token punctuation">(</span><span class="token variable">Input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">do_create</span><span class="token punctuation">(</span><span class="token variable">Input</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token comment">% here the Input variable will contain the POST request' body, which will most likely be a JSON, which we also will need to parse</span>
  <span class="token punctuation">[</span><span class="token string">"Status: 204 No Content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>
</code></pre>
<p>As you can see, this is a pretty complex example, since the API of <code>httpd</code> module is rather low-level - we have to explicitly form a HTTP response and send it back to clients.
Although not impossible, it is just not so pleasant development experience as it could be. Read on to see how it could be significantly improved.</p>
<h3 id="mnesia">Mnesia</h3>
<p>Erlang is bundled with a distributed real-time database called Mnesia!</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">visit_tracker</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token atom">init</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token atom">create_schema</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token atom">create_account</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token atom">find_account_by_email</span><span class="token operator">/</span><span class="token number">1</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">visit</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">site_id</span><span class="token punctuation">,</span> <span class="token atom">ip</span><span class="token punctuation">,</span> <span class="token atom">browser</span><span class="token punctuation">,</span> <span class="token atom">location</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">site</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">id</span><span class="token punctuation">,</span> <span class="token atom">account_id</span><span class="token punctuation">,</span> <span class="token atom">name</span><span class="token punctuation">,</span> <span class="token atom">visits</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
<span class="token operator">-</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token atom">account</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">id</span><span class="token punctuation">,</span> <span class="token atom">email</span><span class="token punctuation">,</span> <span class="token atom">sites</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">create_schema</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">create_table</span><span class="token punctuation">(</span><span class="token atom">visits</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token atom">attributes</span><span class="token punctuation">,</span> <span class="token function">record_info</span><span class="token punctuation">(</span><span class="token atom">fields</span><span class="token punctuation">,</span> <span class="token atom">visit</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">record_name</span><span class="token punctuation">,</span> <span class="token atom">visit</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">create_table</span><span class="token punctuation">(</span><span class="token atom">sites</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token atom">type</span><span class="token punctuation">,</span> <span class="token atom">bag</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">attributes</span><span class="token punctuation">,</span> <span class="token function">record_info</span><span class="token punctuation">(</span><span class="token atom">fields</span><span class="token punctuation">,</span> <span class="token atom">site</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">record_name</span><span class="token punctuation">,</span> <span class="token atom">site</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">create_table</span><span class="token punctuation">(</span><span class="token atom">accounts</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token atom">type</span><span class="token punctuation">,</span> <span class="token atom">bag</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">attributes</span><span class="token punctuation">,</span> <span class="token function">record_info</span><span class="token punctuation">(</span><span class="token atom">fields</span><span class="token punctuation">,</span> <span class="token atom">account</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token atom">record_name</span><span class="token punctuation">,</span> <span class="token atom">account</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token comment">%% temporarily forcing to put ID by hand</span>
<span class="token function">create_account</span><span class="token punctuation">(</span><span class="token variable">Id</span><span class="token punctuation">,</span> <span class="token variable">Email</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Txn</span> <span class="token operator">=</span> <span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token comment">%% record creation syntax is similar to dictionary / map creation syntax: `#record_name{ key = Value }`</span>
    <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token atom">accounts</span><span class="token punctuation">,</span> <span class="token punctuation">#</span><span class="token atom">account</span><span class="token punctuation">{</span> <span class="token atom">id</span> <span class="token operator">=</span> <span class="token variable">Id</span><span class="token punctuation">,</span> <span class="token atom">email</span> <span class="token operator">=</span> <span class="token variable">Email</span><span class="token punctuation">,</span> <span class="token atom">sites</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token atom">write</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span><span class="token punctuation">,</span>

  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token variable">Txn</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_site</span><span class="token punctuation">(</span><span class="token variable">Account</span><span class="token punctuation">,</span> <span class="token variable">Id</span><span class="token punctuation">,</span> <span class="token variable">Name</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">AccId</span> <span class="token operator">=</span> <span class="token variable">Account</span><span class="token punctuation">#</span><span class="token atom">account</span><span class="token punctuation">.</span><span class="token atom">id</span><span class="token punctuation">,</span>

  <span class="token variable">Txn</span> <span class="token operator">=</span> <span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">[</span> <span class="token variable">_</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token atom">accounts</span><span class="token punctuation">,</span> <span class="token variable">AccId</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">%% mnesia:write(Account),</span>

    <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token atom">sites</span><span class="token punctuation">,</span> <span class="token punctuation">#</span><span class="token atom">site</span><span class="token punctuation">{</span> <span class="token atom">account_id</span> <span class="token operator">=</span> <span class="token variable">AccId</span><span class="token punctuation">,</span> <span class="token atom">id</span> <span class="token operator">=</span> <span class="token variable">Id</span><span class="token punctuation">,</span> <span class="token atom">name</span> <span class="token operator">=</span> <span class="token variable">Name</span><span class="token punctuation">,</span> <span class="token atom">visits</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token atom">write</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span><span class="token punctuation">,</span>

  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token variable">Txn</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_visit</span><span class="token punctuation">(</span><span class="token variable">Site</span><span class="token punctuation">,</span> <span class="token variable">Ip</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token function">create_visit</span><span class="token punctuation">(</span><span class="token variable">Site</span><span class="token punctuation">,</span> <span class="token variable">Ip</span><span class="token punctuation">,</span> <span class="token atom">unknown</span><span class="token punctuation">,</span> <span class="token atom">unknown</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_visit</span><span class="token punctuation">(</span><span class="token variable">Site</span><span class="token punctuation">,</span> <span class="token variable">Ip</span><span class="token punctuation">,</span> <span class="token variable">Browser</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token function">create_visit</span><span class="token punctuation">(</span><span class="token variable">Site</span><span class="token punctuation">,</span> <span class="token variable">Ip</span><span class="token punctuation">,</span> <span class="token variable">Browser</span><span class="token punctuation">,</span> <span class="token atom">unknown</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">create_visit</span><span class="token punctuation">(</span><span class="token variable">Site</span><span class="token punctuation">,</span> <span class="token variable">Ip</span><span class="token punctuation">,</span> <span class="token variable">Browser</span><span class="token punctuation">,</span> <span class="token variable">Location</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token comment">%% retrieving ID field from the Site parameter</span>
  <span class="token variable">SiteId</span> <span class="token operator">=</span> <span class="token variable">Site</span><span class="token punctuation">#</span><span class="token atom">site</span><span class="token punctuation">.</span><span class="token atom">id</span><span class="token punctuation">,</span>

  <span class="token variable">Txn</span> <span class="token operator">=</span> <span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token punctuation">[</span> <span class="token variable">_</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token atom">sites</span><span class="token punctuation">,</span> <span class="token variable">SiteId</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">%% since table name is different to record name, we have to pass table name as the first argument</span>
  <span class="token keyword">end</span><span class="token punctuation">,</span>

  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token variable">Txn</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">find_account_by_email</span><span class="token punctuation">(</span><span class="token variable">Email</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Txn</span> <span class="token operator">=</span> <span class="token keyword">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token comment">%% select semantics:</span>
    <span class="token comment">%%</span>
    <span class="token comment">%%   mnesia:select(Table_name, [ Query, Conditions, ResultMapping ])</span>
    <span class="token comment">%%</span>
    <span class="token comment">%% here,</span>
    <span class="token comment">%%  * Query defines the generic pattern to match agains</span>
    <span class="token comment">%%  * Conditions or Guard is a list of tuples defining the clauses: { operator, field, value }: { '>', 'id', 10 }</span>
    <span class="token comment">%%  * ResultMapping is what will be returned; you can use the pattern matching from the Query param here</span>
    <span class="token comment">%%</span>
    <span class="token comment">%% map / dictionary creation: #{ key => value }</span>

    <span class="token punctuation">[</span> <span class="token variable">Acc</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token atom">accounts</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token punctuation">#</span><span class="token atom">account</span><span class="token punctuation">{</span> <span class="token atom">id</span><span class="token operator">=</span><span class="token quoted-atom atom">'$1'</span><span class="token punctuation">,</span> <span class="token atom">email</span><span class="token operator">=</span><span class="token variable">Email</span><span class="token punctuation">,</span> <span class="token atom">sites</span><span class="token operator">=</span><span class="token quoted-atom atom">'$2'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token punctuation">#</span><span class="token punctuation">{</span> <span class="token atom">id</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token quoted-atom atom">'$1'</span><span class="token punctuation">,</span> <span class="token atom">email</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">Email</span><span class="token punctuation">,</span> <span class="token atom">sites</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token quoted-atom atom">'$2'</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token variable">Acc</span>
  <span class="token keyword">end</span><span class="token punctuation">,</span>

  <span class="token atom">mnesia</span><span class="token punctuation">:</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token variable">Txn</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<h2 id="ecosystem">Ecosystem</h2>
<p>Using <a href="https://hex.pm/">Rebar 3</a> (or <code>Hex</code> for Elixir) is relatively easy. Yet it opens access to thousands of packages available out there.</p>
<h3 id="creating-a-project">Creating a project</h3>
<p>To create a project with rebar3 support, you can now use <code>rebar3 new &lt;template&gt; &lt;app-name&gt;</code>. For just an application, you can use <code>app</code> template name.
For libraries - use <code>lib</code>. Simple!</p>
<p>To add a dependency, edit the <code>rebar.config</code> file in the application directory and change the <code>deps</code> dictionary:</p>
<pre><code class="language-erlang"><span class="token punctuation">{</span><span class="token atom">deps</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token atom">epsql</span><span class="token punctuation">,</span> <span class="token string">"~> 4.6.0"</span><span class="token punctuation">}</span> <span class="token comment">% PostgreSQL package</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>Then, since a single project can have multiple applications, one needs to add the dependency to each application which requires that dependency. This
is done in the <code>*.app.src</code> file in the <em>application</em> root directory (for instance, <code>myapp/appname/appname.app.src</code>):</p>
<pre><code class="language-erlang"><span class="token punctuation">{</span><span class="token atom">application</span><span class="token punctuation">,</span> <span class="token atom">appname</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token atom">description</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token atom">registered</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token atom">modules</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token atom">applications</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">kernel</span><span class="token punctuation">,</span>
                  <span class="token atom">stdlib</span><span class="token punctuation">,</span>
                  <span class="token atom">epsql</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token atom">mod</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token atom">appname_app</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token atom">env</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>Building the project with dependencies is then done using the <code>rebar3 compile</code> command from the <em>project</em> root directory (following the example above, <code>myapp/</code>).</p>
<p>To run an application, use the <code>rebar3 shell --apps &lt;comma-separated-app-names&gt;</code> from the <em>project</em> root directory (e.g. <code>rebar3 shell --apps appname</code>).</p>
<h3 id="postgresql">PostgreSQL</h3>
<p>Working with PostgreSQL in Erlang is possible through one of many libraries available in <a href="https://hex.pm/packages">rebar3 repository</a>.
In this blog I will use <a href="https://github.com/epgsql/epgsql"><code>epsql</code></a> library.</p>
<p>For the most part, when working with the database, you only need a handful of features from the database library:</p>
<ul>
<li>connecting to the database with specific parameters (connection pool size, security options, timeouts, etc.)</li>
<li>executing prepared statements (allowing the DB communication layer - the library - to safely inject query parameters, preventing the SQL injection)</li>
<li>support for <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code> and <code>DELETE</code> statements (with very few exceptions, these form 95% of all the use cases, in my experience)</li>
<li>retrieve query results (as list of dictionaries of sorts)</li>
</ul>
<p>epsql library provides all of these with the following functions:</p>
<ul>
<li><code>epgsql:connect/1</code> (and its variations) in combination with <code>epgsql:close/1</code> to close the connection, if ever needed; <code>epgsql:connect/1</code> takes a dictionary of options, including<ul>
<li><code>host</code></li>
<li><code>username</code> and <code>password</code>; optionally - <code>ssl</code> and <code>ssl_opts</code> for secure connections</li>
<li><code>database</code></li>
<li><code>timeout</code> - for limiting the connection time</li>
</ul>
</li>
<li><code>epgsql:squery/2</code> and <code>epgsql:equery/3</code> to query the database<ul>
<li><code>epgsql:squery/2</code> will execute a simple query (takes connection and a query string as parameters, returns a tuple of status - <code>ok</code> or <code>error</code>, list of columns and list of rows)</li>
<li><code>epgsql:equery/3</code> will create an unnamed prepared statement (yes, you can have named prepared statements for future reuse), safely inject the query parameters (specified as <code>$1</code>, <code>$2</code>, <code>$3</code> and so on in query string, the second argument) passed as the third argument (a list of parameters) and execute the statement on a database connection (passed as the first argument)</li>
</ul>
</li>
</ul>
<p>Here are few simple examples of the above functions:</p>
<pre><code class="language-erlang"><span class="token function">connect_to_blog_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token punctuation">{</span> <span class="token atom">ok</span><span class="token punctuation">,</span> <span class="token variable">C</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom">epsql</span><span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">#</span><span class="token punctuation">{</span> <span class="token atom">host</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token atom">username</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token atom">password</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"****"</span><span class="token punctuation">,</span> <span class="token atom">database</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token string">"blog"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">C</span><span class="token punctuation">.</span>

<span class="token function">create_blog</span><span class="token punctuation">(</span><span class="token variable">Title</span><span class="token punctuation">,</span> <span class="token variable">Content</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">C</span> <span class="token operator">=</span> <span class="token function">connect_to_blog_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token punctuation">{</span> <span class="token atom">ok</span><span class="token punctuation">,</span> <span class="token variable">Count</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom">epsql</span><span class="token punctuation">:</span><span class="token function">equery</span><span class="token punctuation">(</span><span class="token variable">C</span><span class="token punctuation">,</span> <span class="token string">"INSERT INTO posts (title, content) VALUES ($1, $2)"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token variable">Title</span><span class="token punctuation">,</span> <span class="token variable">Content</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">Count</span> <span class="token operator">==</span> <span class="token number">1.</span>

<span class="token function">get_blogs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">C</span> <span class="token operator">=</span> <span class="token function">connect_to_blog_db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token punctuation">{</span> <span class="token atom">ok</span><span class="token punctuation">,</span> <span class="token variable">Columns</span><span class="token punctuation">,</span> <span class="token variable">Rows</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom">epsql</span><span class="token punctuation">:</span><span class="token function">squery</span><span class="token punctuation">(</span><span class="token variable">C</span><span class="token punctuation">,</span> <span class="token string">"SELECT title, content FROM posts"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">Rows</span><span class="token punctuation">.</span>
</code></pre>
<h3 id="mochi-http-server">Mochi HTTP server</h3>
<p>As shown above, the default HTTP server bundled with Erlang standard library (OTP) is rather low-level.
There are few options in rebar3 package repository which significantly improve the situation. One of them is <a href="https://github.com/mochi/mochiweb/"><code>mochiweb</code></a>.</p>
<p>The web server with Mochi could look like this (slightly more complex than the one described above with <code>httpd</code>):</p>
<pre><code class="language-erlang"><span class="token operator">-</span><span class="token function">module</span><span class="token punctuation">(</span><span class="token atom">http_sample</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">export</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token atom">dispatch</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token atom">loop</span><span class="token operator">/</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token atom">start</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token atom">stop</span><span class="token operator">/</span><span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token operator">-</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token variable">HTTP_OPTS</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token atom">loop</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token variable">?MODULE</span><span class="token punctuation">,</span> <span class="token atom">dispatch</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token atom">port</span><span class="token punctuation">,</span> <span class="token number">4000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token atom">name</span><span class="token punctuation">,</span> <span class="token atom">http_4000</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token punctuation">{</span> <span class="token atom">ok</span><span class="token punctuation">,</span> <span class="token variable">Http</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token atom">mochiweb_http</span><span class="token punctuation">:</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token variable">?HTTP_OPTS</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">Pid</span> <span class="token operator">=</span> <span class="token function">spawn_link</span><span class="token punctuation">(</span><span class="token keyword">fun</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token variable">Http</span><span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token function">register</span><span class="token punctuation">(</span><span class="token atom">http_sample</span><span class="token punctuation">,</span> <span class="token variable">Pid</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">ok</span><span class="token punctuation">.</span>

<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token atom">http_sample</span> <span class="token operator">!</span> <span class="token atom">stop</span><span class="token punctuation">,</span>

  <span class="token atom">ok</span><span class="token punctuation">.</span>

<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token keyword">case</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token atom">method</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span> <span class="token keyword">of</span>
    <span class="token quoted-atom atom">'GET'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">get_resource</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token quoted-atom atom">'PUT'</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">put_resource</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">_</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">method_not_allowed</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span><span class="token punctuation">.</span>

<span class="token function">get_resource</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Path</span> <span class="token operator">=</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token atom">path</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token comment">% note: io:format(FmtString, Params) would print to STDOUT</span>
  <span class="token comment">% whereas io_lib:format(FmtString, Params) will return a formatted string</span>
  <span class="token variable">Body</span> <span class="token operator">=</span> <span class="token atom">io_lib</span><span class="token punctuation">:</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello, Resource '~s'\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token variable">Path</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">Headers</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/plain"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token variable">Headers</span><span class="token punctuation">,</span> <span class="token variable">Body</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">ok</span><span class="token punctuation">.</span>

<span class="token function">put_resource</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">ContentType</span> <span class="token operator">=</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">get_header_value</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">ReqBody</span> <span class="token operator">=</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">recv_body</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token number">201</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"201 Created\r\n"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">ok</span><span class="token punctuation">.</span>

<span class="token function">method_not_allowed</span><span class="token punctuation">(</span><span class="token variable">Req</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token variable">Path</span> <span class="token operator">=</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token atom">path</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token variable">Method</span> <span class="token operator">=</span> <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token atom">method</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token variable">Body</span> <span class="token operator">=</span> <span class="token atom">io_lib</span><span class="token punctuation">:</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Method ~s on path ~s is not supported"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token variable">Method</span><span class="token punctuation">,</span> <span class="token variable">Path</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">mochiweb_request</span><span class="token punctuation">:</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token number">405</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">Body</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">Req</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  <span class="token atom">ok</span><span class="token punctuation">.</span>

<span class="token function">loop</span><span class="token punctuation">(</span><span class="token variable">Http</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
  <span class="token keyword">receive</span>
    <span class="token atom">stop</span> <span class="token operator">-</span><span class="token operator">></span>
      <span class="token atom">ok</span> <span class="token operator">=</span> <span class="token atom">mochiweb_http</span><span class="token punctuation">:</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token variable">Http</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">exit</span><span class="token punctuation">(</span><span class="token atom">normal</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">_</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token atom">ignore</span>
  <span class="token keyword">end</span><span class="token punctuation">,</span>

  <span class="token punctuation">(</span><span class="token variable">?MODULE</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token variable">Http</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
</code></pre>
<p>For this code to run, you should do few little extra steps. First, creating the new application with <code>rebar3</code> - I prefer <code>escript</code> template for something this simple.</p>
<p>Then, add a new dependency to the <code>rebar.config</code> file:</p>
<pre><code class="language-erlang"><span class="token punctuation">{</span><span class="token atom">erl_opts</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">debug_info</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
<span class="token punctuation">{</span><span class="token atom">deps</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token atom">mochiweb</span><span class="token punctuation">,</span> <span class="token string">"2.22.0"</span><span class="token punctuation">}</span> <span class="token comment">% &lt;---- here</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>

<span class="token punctuation">{</span><span class="token atom">shell</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token comment">% {config, "config/sys.config"},</span>
    <span class="token punctuation">{</span><span class="token atom">apps</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom">http_sample</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">.</span>
</code></pre>
<p>Then, put the code from above under <code>src/http_server.erl</code> file.</p>
<p>Finally, run the interactive shell in the context of the application: <code>rebar3 shell</code> and start server by calling <code>http_server:start().</code>.</p>
<p>Alternatively, you can compile the program to a binary file using <code>rebar3 compile</code> and then run the program using <code>erl</code> command:</p>
<pre><code class="language-bash">erl -pa _build/default/lib/http_sample3/ebin/ -pa _build/default/lib/mochiweb/ebin/ -noshell -s http_sample3 main
</code></pre>
<p>This, however, will immediately stop the execution of a program once the <code>http_sample3:main/0</code> finishes, so you might want to change the source a bit:</p>
<pre><code class="language-erlang"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token variable">Args</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span>
    <span class="token atom">io</span><span class="token punctuation">:</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Hello, server!~n"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token atom">http_server</span><span class="token punctuation">:</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token keyword">receive</span>
        <span class="token atom">stop</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token atom">http_server</span><span class="token punctuation">:</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">end</span><span class="token punctuation">,</span>

    <span class="token atom">done</span><span class="token punctuation">.</span>
</code></pre>
<p>This way, the <code>http_sample3:main/1</code> will be called and will wait for the <code>stop</code> signal to be sent to the process.
Or until the main <code>erl</code> process is terminated.</p>
<p>Finally you should be able to communicate with this rather simple server by using <code>curl</code>, for example:</p>
<pre><code class="language-bash"><span class="token function">curl</span> http://localhost:4000/my/resource -X PUT -d <span class="token string">'{ "name": "message", "value": "my message" }'</span>
</code></pre>
<h2 id="summary">Summary</h2>
<p>This blog was supposed to show Erlang from a slighly different perspective, as opposed to how it was presented to me
in uni. I guess you could treat this as a “Practical Erlang” blog.</p>
<p>This post was supposed to be released in mid-2020, but it took me quite a while to polish it. In the next blog I will
build this on to provide a much more exciting application sample with Erlang.</p>
</div>
</article></main>

    

    <script src="/blog2-ssr/lazyLoadImages.js"></script></body>
</html>