<style>:root{--left-side:200px;--right-side:200px;--nav-height:64px;--background-color:#FFD166;--primary-color:#06D6A0;--primary-accent-color:#049F76;--secondary-color:#118AB2;--sub-color:#073B4C;--nav-background:#fff;--article-background:#fff
    }body.svelte-1gr3n62.svelte-1gr3n62{padding:0;margin:0;color:var(--sub-color);background:var(--background-color);font-family:Roboto, "Helvetica Neue", Arial, sans-serif;font-size:18px;display:grid;grid-template:var(--nav-height) auto var(--nav-height)/var(--left-side) calc(100% - var(--left-side) - var(--right-side)) var(--right-side)
    }nav.top.svelte-1gr3n62 .links.svelte-1gr3n62{grid-area:1/2/2/3;display:flex;align-items:center
    }nav.top.svelte-1gr3n62 .links a.svelte-1gr3n62{margin-right:1em
    }a.svelte-1gr3n62.svelte-1gr3n62{color:var(--secondary-color);text-decoration:none
    }a.svelte-1gr3n62.svelte-1gr3n62:hover,a.svelte-1gr3n62.svelte-1gr3n62:active{color:var(--sub-color)
    }footer.svelte-1gr3n62.svelte-1gr3n62{grid-area:3/1/4/4;background:#fff;display:inline-grid;grid-template:100%/var(--left-side) auto var(--right-side)
    }nav.top.svelte-1gr3n62.svelte-1gr3n62{background-color:var(--nav-background);display:inline-grid;grid-template:100%/var(--left-side) auto var(--right-side);grid-area:1/1/2/4
    }main.svelte-1gr3n62.svelte-1gr3n62{grid-area:2/2/3/3;margin-top:1em;display:flex;flex-direction:column
    }@media screen and (max-width: 1340px){:root{--left-side:0px;--right-side:0px
        }body.svelte-1gr3n62.svelte-1gr3n62{background:var(--background-color)
        }nav.top.svelte-1gr3n62 .links.svelte-1gr3n62{justify-content:space-around
        }}
.btn.svelte-7idbpu{display:inline-flex;font-size:18px;color:#fff;background:var(--primary-color);padding:10px;border-radius:8px
    }.btn.svelte-7idbpu:hover{background:var(--primary-accent-color);color:#fff
    }</style><!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="/images/favicon-compressed.webp">
    <link rel="shortcut icon" href="/images/favicon-compressed.webp">
    <link rel="apple-touch-icon" href="/images/favicon-compressed.webp">

    <link rel="stylesheet" href="/shared.css">
    <link rel="stylesheet" href="/prism.css">

    <title>Document</title></head>
<body class="svelte-1gr3n62"><nav class="top svelte-1gr3n62">
            <div class="links svelte-1gr3n62"><a class="nav-link nav-item svelte-1gr3n62" href="/">Home</a>
                <a class="nav-link nav-item svelte-1gr3n62" href="/about/">About</a></div>
        </nav>

    <main class="svelte-1gr3n62"><article><h1>Improving ZSH startup performance</h1>

    <time>01 Jun 2018 at 04:00</time>

    <div class="content"><h2 id="adding-profiling-to-zsh">Adding profiling to ZSH</h2>
<p>Add this line as the first one, to the very top of your <code>~/.zshrc</code>:</p>
<pre><code>zmodload zsh/zprof
</code></pre>
<p>And add this one to the very bottom of this same file:</p>
<pre><code>zprof
</code></pre>
<p>Now, whenever you open up ZSH, you shall see a list of things which start and how much time each entry takes to load.
For me it was like this:</p>
<pre><code>num  calls                time                       self            name
-----------------------------------------------------------------------------------
 1)    1        1123.49  1123.49   87.59%   1123.49  1123.49   87.59%  _pyenv-from-homebrew-installed
 2)    1          84.02    84.02    6.55%     59.50    59.50    4.64%  compinit
 3)    3          26.94     8.98    2.10%     26.94     8.98    2.10%  __sdkman_export_candidate_home
 4)    3          25.77     8.59    2.01%     25.77     8.59    2.01%  __sdkman_prepend_candidate_to_path
 5)    2          24.52    12.26    1.91%     24.52    12.26    1.91%  compaudit
 6)    2           7.98     3.99    0.62%      7.98     3.99    0.62%  grep-flag-available
 7)    2           7.54     3.77    0.59%      7.54     3.77    0.59%  env_default
 8)    2           2.43     1.22    0.19%      2.43     1.22    0.19%  _has
 9)   23           2.43     0.11    0.19%      2.43     0.11    0.19%  compdef
10)    1           1.09     1.09    0.09%      1.09     1.09    0.09%  colors
11)   12           0.38     0.03    0.03%      0.38     0.03    0.03%  is_plugin
12)    1           0.38     0.38    0.03%      0.38     0.38    0.03%  is-at-least
13)    1           0.21     0.21    0.02%      0.21     0.21    0.02%  _homebrew-installed
14)    1           0.03     0.03    0.00%      0.03     0.03    0.00%  __sdkman_echo_debug

-----------------------------------------------------------------------------------
</code></pre>
<p>I was able to measure the total startup time by running <code>time zsh -i -c exit</code>. And the total startup time was <strong>almost two seconds</strong>.</p>
<pre><code>zsh -i -c exit  1.16s user 0.73s system 100% cpu 1.889 total
</code></pre>
<p>As you can see, <code>pyenv</code> takes whole bunch of time (1123 millis!). So I do have the <code>pyenv</code> plugin for ZSH and I did disable it. Hereâ€™s what happened afterwards:</p>
<pre><code>num  calls                time                       self            name
-----------------------------------------------------------------------------------
 1)    1          91.42    91.42   53.38%     62.48    62.48   36.48%  compinit
 2)    2          28.94    14.47   16.90%     28.94    14.47   16.90%  compaudit
 3)    3          28.62     9.54   16.71%     28.62     9.54   16.71%  __sdkman_export_candidate_home
 4)    3          27.65     9.22   16.14%     27.65     9.22   16.14%  __sdkman_prepend_candidate_to_path
 5)    2           8.27     4.14    4.83%      8.27     4.14    4.83%  grep-flag-available
 6)    2           8.22     4.11    4.80%      8.22     4.11    4.80%  env_default
 7)    2           2.55     1.28    1.49%      2.55     1.28    1.49%  _has
 8)   23           2.50     0.11    1.46%      2.50     0.11    1.46%  compdef
 9)    1           1.24     1.24    0.72%      1.24     1.24    0.72%  colors
10)    1           0.41     0.41    0.24%      0.41     0.41    0.24%  is-at-least
11)   10           0.37     0.04    0.21%      0.37     0.04    0.21%  is_plugin
12)    1           0.02     0.02    0.01%      0.02     0.02    0.01%  __sdkman_echo_debug

-----------------------------------------------------------------------------------
</code></pre>
<pre><code>zsh -i -c exit  0.28s user 0.23s system 96% cpu 0.526 total
</code></pre>
<h2 id="nvm">NVM</h2>
<p>Not to forget I had NVM installed with the default settings.</p>
<p>With it I had the startup time of <code>1.9</code> seconds:</p>
<pre><code>zsh -i -c exit  1.17s user 0.74s system 99% cpu 1.916 total
</code></pre>
<p>If you follow this <a href="http://www.growingwiththeweb.com/2018/01/slow-nvm-init.html">simple instruction</a> or just replace these two lines, initializing NVM in your <code>~/.zshrc</code> file:</p>
<pre><code class="language-bash"><span class="token punctuation">[</span> -s <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="token comment"># This loads nvm</span>
<span class="token punctuation">[</span> -s <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>. <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span>  <span class="token comment"># This loads nvm bash_completion</span>
</code></pre>
<p>with these lines:</p>
<pre><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> -s <span class="token string">"<span class="token environment constant">$HOME</span>/.nvm/nvm.sh"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">type</span> __init_nvm<span class="token variable">)</span></span>"</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">export</span> <span class="token assign-left variable">NVM_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/.nvm"</span>

 <span class="token punctuation">[</span> -s <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span> <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">.</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>/bash_completion"</span>

 <span class="token builtin class-name">declare</span> -a <span class="token assign-left variable">__node_commands</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">'nvm'</span> <span class="token string">'node'</span> <span class="token string">'npm'</span> <span class="token string">'yarn'</span> <span class="token string">'gulp'</span> <span class="token string">'grunt'</span> <span class="token string">'webpack'</span><span class="token punctuation">)</span>

 <span class="token keyword">function</span> <span class="token function-name function">__init_nvm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${__node_commands<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">unalias</span> <span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
   <span class="token builtin class-name">.</span> <span class="token string">"<span class="token variable">$NVM_DIR</span>"</span>/nvm.sh
   <span class="token builtin class-name">unset</span> __node_commands
   <span class="token builtin class-name">unset</span> -f __init_nvm
 <span class="token punctuation">}</span>

 <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${__node_commands<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token builtin class-name">alias</span> <span class="token variable">$i</span><span class="token operator">=</span><span class="token string">'__init_nvm &amp;&amp; '</span><span class="token variable">$i</span><span class="token punctuation">;</span> <span class="token keyword">done</span>
<span class="token keyword">fi</span>
</code></pre>
<p>The start-up time drops by <code>0.1</code> second. But it still is an improvement, right?</p>
</div>
</article></main>

    

    <script src="/lazyLoadImages.js"></script></body>
</html>